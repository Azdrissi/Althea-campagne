{% extends 'base.html' %}

{% block title %}Liste des Élèves{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4"><i class="fas fa-users"></i> Liste des Élèves</h2>

    <!-- Boutons en haut -->
    <div class="d-flex justify-content-start mb-3">
        <a href="{{ url_for('students.new_student') }}" class="btn btn-success">
            <i class="fas fa-plus-circle"></i> Nouvel Élève
        </a>
    </div>

    <!-- Section Recherche et Filtres -->
    <div class="card mb-3">
        <div class="card-body">
            <h5><i class="fas fa-filter"></i> Recherche et Filtres</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <input type="text" class="form-control" id="searchInput" placeholder="Nom, prénom, observations...">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="villeFilter"><option value="">Toutes les villes</option></select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="ecoleFilter"><option value="">Toutes les écoles</option></select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statutFilter"><option value="">Tous les statuts</option></select>
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-primary" onclick="applyFilters()"><i class="fas fa-search"></i> Rechercher</button>
            </div>
        </div>
    </div>

    <!-- Tableau -->
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-light">
                <tr>
                    <th>ID</th><th>Ville</th><th>École</th><th>Classe</th><th>Nom</th><th>Prénom</th><th>Âge</th><th>Statut</th><th>Prise en charge</th><th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr>
                    <td>{{ student.id }}</td>
                    <td>{{ student.ville }}</td>
                    <td>{{ student.ecole }}</td>
                    <td>{% if student.classe %}<span class="badge bg-primary">{{ student.classe }}</span>{% else %}-{% endif %}</td>
                    <td><strong>{{ student.nom }}</strong></td>
                    <td>{{ student.prenom }}</td>
                    <td>{{ student.age if student.age else '' }}</td>
                    <td>{% if student.statut %}<span class="badge bg-warning text-dark">{{ student.statut }}</span>{% else %}<span class="badge bg-warning text-dark">Pré-listé</span>{% endif %}</td>
                    <td>{{ student.prise_en_charge or '-' }}</td>
                    <td>
                                                <div class="btn-group btn-group-sm">
                            <!-- Modifier -->
                            <a href="{{ url_for('students.edit_student', id=student.id) }}"
                               class="btn btn-outline-primary"
                               title="Modifier">
                                <i class="bi bi-pencil"></i>
                            </a>

                            <!-- Imprimer sur fiche Althea (pré-imprimée) -->
                            <a href="{{ url_for('students.print_student_preprinted', student_id=student.id) }}"
                               class="btn btn-outline-secondary"
                               title="Imprimer sur fiche Althea">
                                <i class="bi bi-printer"></i>
                            </a>

                            <!-- Imprimer fiche PDF -->
                            <a href="{{ url_for('printing.print_form', student_id=student.id) }}"
                               class="btn btn-outline-danger"
                               title="Imprimer fiche PDF"
                               target="_blank">
                                <i class="bi bi-file-pdf"></i>
                            </a>

                            <!-- Supprimer -->
                            <button onclick="confirmDelete({{ student.id }}, '{{ student.nom }} {{ student.prenom }}')"
                                    class="btn btn-outline-info"
                                    title="Supprimer">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if students|length == 0 %}
    <div class="alert alert-info"><i class="fas fa-info-circle"></i> Aucun élève trouvé.</div>
    {% endif %}
</div>

<script>
function confirmDelete(studentId, studentName) {
    if (confirm('Êtes-vous sûr de vouloir supprimer ' + studentName + ' ?')) {
        fetch('/students/delete/' + studentId, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur lors de la suppression');
            }
        });
    }
}

function applyFilters() {
    const search = document.getElementById('searchInput').value;
    const ville = document.getElementById('villeFilter').value;
    const ecole = document.getElementById('ecoleFilter').value;
    const statut = document.getElementById('statutFilter').value;
    let url = '/students/?';
    if (search) url += 'search=' + encodeURIComponent(search) + '&';
    if (ville) url += 'ville=' + encodeURIComponent(ville) + '&';
    if (ecole) url += 'ecole=' + encodeURIComponent(ecole) + '&';
    if (statut) url += 'statut=' + encodeURIComponent(statut);
    window.location.href = url;
}
</script>
{% endblock %}
