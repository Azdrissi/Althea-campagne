{% extends "base.html" %}

{% block title %}Statistiques{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2><i class="bi bi-graph-up me-2"></i>Statistiques de la Campagne</h2>
        </div>
    </div>

    <!-- CARTES INDICATEURS PRINCIPAUX -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center border-primary">
                <div class="card-body">
                    <i class="bi bi-people-fill fs-1 text-primary"></i>
                    <h3 class="mt-3">{{ total_students }}</h3>
                    <p class="text-muted mb-0">Total Élèves</p>
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-center border-success">
                <div class="card-body">
                    <i class="bi bi-check-circle fs-1 text-success"></i>
                    <h3 class="mt-3">{{ consultations_completees }}</h3>
                    <p class="text-muted mb-0">Consultations</p>
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <i class="bi bi-eyeglasses fs-1 text-warning"></i>
                    <h3 class="mt-3">{{ lunettes_prescrites }}</h3>
                    <p class="text-muted mb-0">Lunettes</p>
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-center border-danger">
                <div class="card-body">
                    <i class="bi bi-hospital fs-1 text-danger"></i>
                    <h3 class="mt-3">{{ referes }}</h3>
                    <p class="text-muted mb-0">Référés</p>
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-center border-info">
                <div class="card-body">
                    <i class="bi bi-clipboard-check fs-1 text-info"></i>
                    <h3 class="mt-3">{{ ras }}</h3>
                    <p class="text-muted mb-0">RAS</p>
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-center border-secondary">
                <div class="card-body">
                    <i class="bi bi-percent fs-1 text-secondary"></i>
                    <h3 class="mt-3">{{ ((consultations_completees / total_students * 100)|round(1) if total_students > 0 else 0) }}%</h3>
                    <p class="text-muted mb-0">Taux Complétude</p>
                </div>
            </div>
        </div>
    </div>

    <!-- RÉPARTITION PAR VILLE -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Répartition par Ville</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>Ville</th>
                                    <th class="text-end">Total</th>
                                    <th class="text-end">Consultés</th>
                                    <th class="text-end">Lunettes</th>
                                    <th class="text-end">Médic.</th>
                                    <th class="text-end">Réf.OPH</th>
                                    <th class="text-end">Réf.Ortho</th>
                                    <th class="text-end">Chirurgie</th>
                                    <th class="text-end">RAS</th>
                                    <th class="text-end">Taux</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if stats_ville %}
                                    {% for ville, total, consultes, lunettes, medicament, refere_oph, refere_ortho, chirurgie, ras_nb in stats_ville %}
                                    <tr>
                                        <td><strong>{{ ville or 'Non spécifié' }}</strong></td>
                                        <td class="text-end">{{ total }}</td>
                                        <td class="text-end"><span class="badge bg-success">{{ consultes }}</span></td>
                                        <td class="text-end"><span class="badge bg-warning text-dark">{{ lunettes }}</span></td>
                                        <td class="text-end"><span class="badge bg-primary">{{ medicament }}</span></td>
                                        <td class="text-end"><span class="badge bg-danger">{{ refere_oph }}</span></td>
                                        <td class="text-end"><span class="badge bg-danger">{{ refere_ortho }}</span></td>
                                        <td class="text-end"><span class="badge bg-dark">{{ chirurgie }}</span></td>
                                        <td class="text-end"><span class="badge bg-info">{{ ras_nb }}</span></td>
                                        <td class="text-end"><strong>{{ ((consultes / total * 100)|round(1) if total > 0 else 0) }}%</strong></td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="10" class="text-center text-muted">Aucune donnée</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RÉPARTITION PAR ÉCOLE -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-building me-2"></i>Répartition par École</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>École</th>
                                    <th>Ville</th>
                                    <th class="text-end">Total</th>
                                    <th class="text-end">Consultés</th>
                                    <th class="text-end">Lunettes</th>
                                    <th class="text-end">Médic.</th>
                                    <th class="text-end">Réf.OPH</th>
                                    <th class="text-end">Réf.Ortho</th>
                                    <th class="text-end">Chirurgie</th>
                                    <th class="text-end">RAS</th>
                                    <th class="text-end">Taux</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if stats_ecole %}
                                    {% for ecole, ville, total, consultes, lunettes, medicament, refere_oph, refere_ortho, chirurgie, ras_nb in stats_ecole %}
                                    <tr>
                                        <td><strong>{{ ecole or 'Non spécifié' }}</strong></td>
                                        <td>{{ ville }}</td>
                                        <td class="text-end">{{ total }}</td>
                                        <td class="text-end"><span class="badge bg-success">{{ consultes }}</span></td>
                                        <td class="text-end"><span class="badge bg-warning text-dark">{{ lunettes }}</span></td>
                                        <td class="text-end"><span class="badge bg-primary">{{ medicament }}</span></td>
                                        <td class="text-end"><span class="badge bg-danger">{{ refere_oph }}</span></td>
                                        <td class="text-end"><span class="badge bg-danger">{{ refere_ortho }}</span></td>
                                        <td class="text-end"><span class="badge bg-dark">{{ chirurgie }}</span></td>
                                        <td class="text-end"><span class="badge bg-info">{{ ras_nb }}</span></td>
                                        <td class="text-end"><strong>{{ ((consultes / total * 100)|round(1) if total > 0 else 0) }}%</strong></td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="11" class="text-center text-muted">Aucune donnée</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- ANALYSE PRESCRIPTIONS MYOPIE -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-eye me-2"></i>Myopie (Sph négatif)</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th class="text-end">Nombre</th>
                                <th class="text-end">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Myopie faible (> -3.00)</td>
                                <td class="text-end"><strong>{{ prescriptions.myopie_faible }}</strong></td>
                                <td class="text-end">{{ ((prescriptions.myopie_faible / lunettes_prescrites * 100)|round(1) if lunettes_prescrites > 0 else 0) }}%</td>
                            </tr>
                            <tr>
                                <td>Myopie forte (≤ -3.00)</td>
                                <td class="text-end"><strong>{{ prescriptions.myopie_forte }}</strong></td>
                                <td class="text-end">{{ ((prescriptions.myopie_forte / lunettes_prescrites * 100)|round(1) if lunettes_prescrites > 0 else 0) }}%</td>
                            </tr>
                            <tr class="table-warning">
                                <td><strong>Myopie + Astigmatisme</strong></td>
                                <td class="text-end"><strong>{{ prescriptions.myopie_astigmate }}</strong></td>
                                <td class="text-end">{{ ((prescriptions.myopie_astigmate / lunettes_prescrites * 100)|round(1) if lunettes_prescrites > 0 else 0) }}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ANALYSE PRESCRIPTIONS HYPERMÉTROPIE -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-eye me-2"></i>Hypermétropie (Sph positif)</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th class="text-end">Nombre</th>
                                <th class="text-end">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Hypermétropie faible (< +3.00)</td>
                                <td class="text-end"><strong>{{ prescriptions.hypermetropie_faible }}</strong></td>
                                <td class="text-end">{{ ((prescriptions.hypermetropie_faible / lunettes_prescrites * 100)|round(1) if lunettes_prescrites > 0 else 0) }}%</td>
                            </tr>
                            <tr>
                                <td>Hypermétropie forte (≥ +3.00)</td>
                                <td class="text-end"><strong>{{ prescriptions.hypermetropie_forte }}</strong></td>
                                <td class="text-end">{{ ((prescriptions.hypermetropie_forte / lunettes_prescrites * 100)|round(1) if lunettes_prescrites > 0 else 0) }}%</td>
                            </tr>
                            <tr class="table-warning">
                                <td><strong>Hypermétropie + Astigmatisme</strong></td>
                                <td class="text-end"><strong>{{ prescriptions.hypermetropie_astigmate }}</strong></td>
                                <td class="text-end">{{ ((prescriptions.hypermetropie_astigmate / lunettes_prescrites * 100)|round(1) if lunettes_prescrites > 0 else 0) }}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- ASTIGMATISME SEUL -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-circle-half me-2"></i>Astigmatisme (seul)</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th class="text-end">Nombre</th>
                                <th class="text-end">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Astigmatisme faible (< 1.00)</td>
                                <td class="text-end"><strong>{{ prescriptions.astigmatisme_faible }}</strong></td>
                                <td class="text-end">{{ ((prescriptions.astigmatisme_faible / lunettes_prescrites * 100)|round(1) if lunettes_prescrites > 0 else 0) }}%</td>
                            </tr>
                            <tr>
                                <td>Astigmatisme moyen (1.00-2.00)</td>
                                <td class="text-end"><strong>{{ prescriptions.astigmatisme_moyen }}</strong></td>
                                <td class="text-end">{{ ((prescriptions.astigmatisme_moyen / lunettes_prescrites * 100)|round(1) if lunettes_prescrites > 0 else 0) }}%</td>
                            </tr>
                            <tr>
                                <td>Astigmatisme fort (> 2.00)</td>
                                <td class="text-end"><strong>{{ prescriptions.astigmatisme_fort }}</strong></td>
                                <td class="text-end">{{ ((prescriptions.astigmatisme_fort / lunettes_prescrites * 100)|round(1) if lunettes_prescrites > 0 else 0) }}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TYPES DE PRISE EN CHARGE -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-clipboard2-pulse me-2"></i>Détail Prises en Charge</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th class="text-end">Nombre</th>
                                <th class="text-end">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for type, count in stats_prise_en_charge.items() %}
                            <tr>
                                <td><strong>{{ type }}</strong></td>
                                <td class="text-end"><span class="badge bg-primary">{{ count }}</span></td>
                                <td class="text-end">{{ ((count / total_students * 100)|round(1) if total_students > 0 else 0) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
